apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: shared-libraries-alerts
  labels:
    role: alert-rules
    app.kubernetes.io/name: shared-libraries
spec:
  groups:
    - name: shared-libraries.slo
      interval: 1m
      rules:
        - alert: SharedLibrariesHighErrorRate
          expr: |
            (
              sum(rate(http_server_requests_failed_total{service_name=~"{{ $service | default \".*\" }}"}[5m]))
              /
              sum(rate(http_server_duration_seconds_count{service_name=~"{{ $service | default \".*\" }}"}[5m]))
            ) > 0.02
          for: 10m
          labels:
            severity: critical
            service: "{{ $service | default \"all\" }}"
          annotations:
            summary: "Shared libraries HTTP error rate above 2% (service={{ $service | default \"all\" }})"
            description: |
              Error responses have exceeded 2% over the past 10 minutes.
              Check recent deploys and audit logs generated by @ai-aas/shared middleware.
            runbook_url: https://github.com/otherjamesbrown/ai-aas/blob/main/docs/upgrades/shared-libraries.md
        - alert: SharedLibrariesLatencyDegradation
          expr: |
            histogram_quantile(
              0.95,
              sum by (le) (rate(http_server_duration_seconds_bucket{service_name=~"{{ $service | default \".*\" }}"}[5m]))
            ) > 0.75
          for: 15m
          labels:
            severity: warning
            service: "{{ $service | default \"all\" }}"
          annotations:
            summary: "Shared libraries latency p95 above 750ms (service={{ $service | default \"all\" }})"
            description: |
              The p95 latency for HTTP handlers wrapped with shared middleware has exceeded 750ms.
              Inspect downstream dependencies and recent request spikes.
            runbook_url: https://github.com/otherjamesbrown/ai-aas/blob/main/docs/upgrades/shared-libraries.md
        - alert: SharedLibrariesExporterFailures
          expr: |
            increase(shared_telemetry_export_failures_total{service_name=~"{{ $service | default \".*\" }}"}[10m]) > 5
          for: 5m
          labels:
            severity: critical
            service: "{{ $service | default \"all\" }}"
          annotations:
            summary: "Telemetry exporter failures detected (service={{ $service | default \"all\" }})"
            description: |
              More than five telemetry export failures were recorded in the last 10 minutes.
              Ensure the OTLP collector endpoint is reachable and credentials are valid.
            runbook_url: https://github.com/otherjamesbrown/ai-aas/blob/main/docs/upgrades/shared-libraries.md
        - alert: SharedLibrariesDatabaseProbeFailure
          expr: |
            avg_over_time(shared_database_probe_success{service_name=~"{{ $service | default \".*\" }}"}[10m]) < 0.8
          for: 10m
          labels:
            severity: critical
            service: "{{ $service | default \"all\" }}"
          annotations:
            summary: "Database probe success below 80% (service={{ $service | default \"all\" }})"
            description: |
              Health probes for shared database connections are failing.
              Verify DSN credentials and network access to the Postgres cluster.
            runbook_url: https://github.com/otherjamesbrown/ai-aas/blob/main/docs/upgrades/shared-libraries.md

