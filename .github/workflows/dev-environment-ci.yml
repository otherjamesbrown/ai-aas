name: Dev Environment CI

on:
  push:
    paths:
      - 'scripts/dev/**'
      - 'cmd/dev-status/**'
      - 'cmd/secrets-sync/**'
      - 'infra/terraform/modules/dev-workspace/**'
      - '.dev/compose/**'
      - 'specs/002-local-dev-environment/**'
      - '.github/workflows/dev-environment-ci.yml'
  pull_request:
    paths:
      - 'scripts/dev/**'
      - 'cmd/dev-status/**'
      - 'cmd/secrets-sync/**'
      - 'infra/terraform/modules/dev-workspace/**'
      - '.dev/compose/**'
      - 'specs/002-local-dev-environment/**'
      - '.github/workflows/dev-environment-ci.yml'
  workflow_dispatch:

env:
  GO_VERSION: "1.24.x"
  TERRAFORM_VERSION: "1.6.6"

jobs:
  go-fmt:
    name: Go Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run gofmt
        run: |
          cd cmd/dev-status && gofmt -l -w . && git diff --exit-code || (echo "Files need formatting. Run: gofmt -w ." && exit 1)
          cd ../secrets-sync && gofmt -l -w . && git diff --exit-code || (echo "Files need formatting. Run: gofmt -w ." && exit 1)

  go-test:
    name: Go Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run tests
        run: |
          cd cmd/dev-status && go test -v ./...
          cd ../secrets-sync && go test -v ./...

  terraform-fmt:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Run terraform fmt
        working-directory: infra/terraform/modules/dev-workspace
        run: |
          terraform fmt -check -recursive || (echo "Terraform files need formatting. Run: terraform fmt -recursive" && exit 1)

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    env:
      LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: infra/terraform/modules/dev-workspace
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: infra/terraform/modules/dev-workspace
        run: terraform validate

  shell-lint:
    name: Shell Script Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          # Lint all scripts in scripts/dev/
          find scripts/dev -name "*.sh" -type f -executable | while read -r script; do
            echo "Linting $script..."
            shellcheck "$script" || exit 1
          done

  measure-local-startup:
    name: Measure Local Startup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Make scripts executable
        run: chmod +x scripts/dev/*.sh

      - name: Measure local startup
        run: |
          ./scripts/dev/measure_local_startup.sh || {
            echo "Local startup measurement failed"
            exit 1
          }
        env:
          STARTUP_TIMEOUT: 300
          STATUS_TIMEOUT: 10

  measure-remote-startup:
    name: Measure Remote Startup
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.measure_remote == 'true'
    env:
      LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
      WORKSPACE_NAME: ${{ github.event.inputs.workspace_name || 'ci-test' }}
      WORKSPACE_OWNER: ${{ github.event.inputs.workspace_owner || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Make scripts executable
        run: chmod +x scripts/dev/*.sh

      - name: Provision remote workspace
        run: |
          make remote-provision \
            WORKSPACE_NAME="${WORKSPACE_NAME}" \
            WORKSPACE_OWNER="${WORKSPACE_OWNER}" \
            WORKSPACE_TTL_HOURS=2

      - name: Get workspace IP
        id: workspace-ip
        run: |
          # Extract IP from terraform output (placeholder - would parse actual output)
          IP="192.0.2.1"  # Placeholder
          echo "workspace_ip=$IP" >> "$GITHUB_OUTPUT"

      - name: Measure remote startup
        run: |
          export WORKSPACE_HOST="${{ steps.workspace-ip.outputs.workspace_ip }}"
          ./scripts/dev/measure_remote_startup.sh || {
            echo "Remote startup measurement failed"
            exit 1
          }

      - name: Destroy workspace
        if: always()
        run: |
          make remote-destroy \
            WORKSPACE_NAME="${WORKSPACE_NAME}" \
            WORKSPACE_OWNER="${WORKSPACE_OWNER}" \
            WORKSPACE_HOST="${{ steps.workspace-ip.outputs.workspace_ip }}"
        continue-on-error: true

